{% extends '_layouts/base.html' %}
{% load surveys_tags %}
{% load staticfiles %}
    
<link rel="stylesheet" type="text/css" href="{% static 'css/custom.css' %}" />


{% block page_title %} <h2>The Game</h2> {% endblock page_title %}

{% block page_content %} 
    <div class="col-sm-4">    
        <a href="javascript:history.go(0)">
            <button class="btn btn-danger" type="button">Next Step (refresh) </button>
        </a>
        <button id="refresh_button" class="btn btn-success" type="button"> Next Step (AJAX) </button>
    </div>
    <div class="col-sm-4" id="npc_div" style='position:relative'></div>
    <div class="col-sm-4">
        <div class="col-sm-3"> </div>
        <div id='scoreboard' class="col-sm-6"> </div>
        <div class="col-sm-3"> </div>
    </div>

{% endblock page_content %}


{% block css %}
{% endblock css %}


{% block js %}
    <script>

        function getPanelClass(action){
            if(action == 'Wait'){
                return 'panel panel-primary';
            } else if (action == 'Pass'){
                return 'panel panel-warning';
            } else if (action == 'Passed_Successfully'){
                return 'panel panel-success';
            } else if (action == 'Protest'){
                return 'panel panel-danger';
            } else if (action == 'Pass_Failed'){
                return 'panel panel-default'
            } 
        }

        function getAlertClass(action){
            if(action == 'Wait'){
                return 'alert alert-info';
            } else if (action == 'Pass'){
                return 'alert alert-warning';
            } else if (action == 'Passed_Successfully'){
                return 'alert alert-success';
            } else if (action == 'Protest'){
                return 'alert alert-danger';
            } else if (action == 'Pass_Failed'){
                return 'alert alert-info'
            } 
        }
        function set_npc_list(){
            {% for npc in npc_list %}

                $("<div id='npc_parent_{{forloop.counter}}' style='position:relative' class='" + getPanelClass("{{npc.getAction}}") +"'> \
                    <div class='panel-heading' style='text-align:center'> \
                        <h4 id='name_{{npc.sayHello}}' class='panel-title'> {{npc.sayHello}} __ {{forloop.counter}} </h4> \
                    </div> \
                    <div class='panel-body' id='npc_{{npc.sayHello}}'> \
                        <p id='emotion_{{npc.sayHello}}'> Emotion:{{npc.getEmotion}} </p> \
                        <p id='action_{{npc.sayHello}}'> Action:{{npc.getAction}} </p> \
                        <p id='weights_{{npc.sayHello}}'> Weights:{{npc.getWeights}} </p> \
                        <p id='resources_{{npc.sayHello}}'> Resources:{{npc.getResources}} </p> \
                        <p id='newresources_{{npc.sayHello}}'> New Resources:{{npc.getNewResources}} </p> \
                    </div> \
                </div>").appendTo('#npc_div');

                //$("<li class='list-group-item' style='text-align:center; background-color:#ff00ff'> {{npc.sayHello}} </p>").appendTo('.list-group');
                $("<div  id='scoreboard_{{forloop.counter}}' class='" + getAlertClass("{{npc.getAction}}") + "' style='margin:0; text-align:center;'> {{npc.sayHello}}</div>").appendTo('#scoreboard');
            {% endfor %}
        }


        function updateNPCs(test){
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("GET", "surveys/ajax", true);
            xmlhttp.onload=function(){
                    var npc_data = JSON.parse(xmlhttp.response);

                    //TODO at some point this should be changed to camelCase since it's javascript
                    var name_list = npc_data["names"];
                    var action_list = npc_data["actions"];
                    var emotion_list = npc_data["emotions"];
                    var weight_list = npc_data["weights"];
                    var resource_list = npc_data["resources"];
                    var newresource_list = npc_data["newresources"];
                    var finalAction = npc_data["finalAction"];
                    var passingNPCs = npc_data["passing_list"];

                    if(finalAction){
                        for(var i=0; i < passingNPCs.length; i ++){
                            if(passingNPCs[i] != 0){

                                var movingUp = $('#npc_parent_'+ (passingNPCs[i] + 1));
                                var movingDown = $('#npc_parent_' + passingNPCs[i]);
                                var upHeight = movingUp.outerHeight();
                                //var downHeight = movingDown.outerHeight();
                                $.when(
                                movingUp.animate({top: -upHeight}, 750),
                                movingDown.animate({top: upHeight},750)).then( 
                                function(){ 
                                    movingUp.css('top', '0px');
                                    movingDown.css('top', '0px');
                                    movingUp.insertBefore(movingDown);
                                });


                                $('#npc_parent_'+ (passingNPCs[i]+1)).attr('id', 'temp');
                                $('#npc_parent_'+ passingNPCs[i]).attr('id', 'npc_parent_'+ (passingNPCs[i] + 1));
                                $('#temp').attr('id', 'npc_parent_' + passingNPCs[i]);
                            }
                        }
                    }

                    for(var i = 0; i < npc_data["npc_count"]; i++){
                        $('#name_' + name_list[i]).text(name_list[i] + ' __ ' + (i+1));
                        $('#emotion_'+ name_list[i]).text("Emotion:" + emotion_list[i]);
                        $('#action_'+ name_list[i]).text("Action:" + action_list[i]);
                        $('#weights_'+ name_list[i]).text("Weights:" + weight_list[i]);
                        $('#resources_'+ name_list[i]).text("Resources:" + resource_list[i]);
                        $('#newresources_'+ name_list[i]).text("New Resources:" + newresource_list[i]);
                        $("#npc_parent_"+ (i+1)).attr('class', getPanelClass(action_list[i]));

                        $('#scoreboard_' + (i+1)).attr('class', getAlertClass(action_list[i]));
                        $('#scoreboard_' + (i+1)).html(name_list[i]);
                    }

            }
            xmlhttp.send();
        }

        $('document').ready(function(){
            $('#refresh_button').click(function(){
                updateNPCs();
            });

            set_npc_list();
        });
    </script>
{% endblock js %}



