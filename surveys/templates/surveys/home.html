{% extends '_layouts/base.html' %}
{% load surveys_tags %}
{% load staticfiles %}


{% block page_title %} <h2>The Game</h2> {% endblock page_title %}

{% block page_content %} 
    <div class="col-sm-2">    
        <button id="refresh_button" class="btn btn-success" type="button"> Next Step</button>
    </div>
    <div class="col-sm-7" id="npc_div" style='position:relative'></div>
    <div class="col-sm-3">
        <div class="col-sm-2"> </div>
        <div id='scoreboard' class="col-sm-8"> </div>
        <div class="col-sm-2"> </div>
    </div>

{% endblock page_content %}


{% block css %}
<style>
    * { 
        font-family: Helvetica, Arial;
    }

    dt { 
        float: left; 
        padding: 4px; 
    }

    .graph_bar {
        margin-bottom: 10px;
        color: #fff;
        text-align: center;
        border-radius: 2px;
        height: 30px;
    }

    .neutral_bar{
        background: -webkit-gradient(linear, left top, left bottom, from(#afafd3), to(#d4d4d4));
    }

    .hope_bar {
        background: -webkit-gradient(linear, left top, left bottom, from(#2b669a), to(#4098e6));
    }
    .joy_bar {
        background: -webkit-gradient(linear, left top, left bottom, from(#3b8f3b), to(#5edf5e));
    }
    .fear_bar {
        background: -webkit-gradient(linear, left top, left bottom, from(#965d0c), to(#e38d13));
    }
    .sorrow_bar { 
        background: -webkit-gradient(linear, left top, left bottom, from(#b92c28), to(#6e1b18));
    }



</style>
{% endblock css %}


{% block js %}
    <script>


        String.prototype.format = String.prototype.f = function() {
            var s = this,
                i = arguments.length;

            while (i--) {
                s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
            }
            return s;
        };

        function getPanelClass(action){
            if(action == 'Wait'){
                return 'panel panel-primary';
            } else if (action == 'Pass'){
                return 'panel panel-warning';
            } else if (action == 'Pass_Success'){
                return 'panel panel-success';
            } else if (action == 'Protest'){
                return 'panel panel-danger';
            } else if (action == 'Fail'){
                return 'panel panel-default'
            } 
        }

        function getAlertClass(action){
            if(action == 'Wait'){
                return 'alert alert-info';
            } else if (action == 'Pass'){
                return 'alert alert-warning';
            } else if (action == 'Pass_Success'){
                return 'alert alert-success';
            } else if (action == 'Protest'){
                return 'alert alert-danger';
            } else if (action == 'Pass_Fail'){
                return 'alert alert-info'
            } 
        }
        function formatEmotion(emotionList){
            return "Joy  [" + emotionList[0].substring(4) +  "] Hope [" + emotionList[1].substring(5) + "] Sorrow [" + emotionList[2].substring(7) + "] Fear [" + emotionList[3].substring(5) +"]";
        }

        function formatSpaces(dataList){
            if( typeof dataList[0] == 'undefined'){
                return ''
            }
            return "[" + dataList[0] + "] -- [" + dataList[1] + "] -- [" + dataList[2] +"]";
        }

        function getEmotionPercent(emotions, n){
            switch(n){
                case 0:
                    var joy_string = emotions[0].substring(4);
                    for(var i = 0; i < joy_string.length ; i ++){
                        if(joy_string.charAt(i) == '.'){
                            if((joy_string.charAt(i+1) == '0') && (joy_string.substring(i+1).length > 1)){
                                return joy_string.substring(i+2);
                            }
                            return joy_string.substring(i+1);
                        }
                    }
                    break;
                case 1:
                    var hope_string = emotions[1].substring(5);
                    for(var i = 0; i < hope_string.length ; i ++){
                        if(hope_string.charAt(i) == '.'){
                            if((hope_string.charAt(i+1) == '0') && (hope_string.substring(i+1).length > 1)){
                                return hope_string.substring(i+2);
                            }
                            return hope_string.substring(i+1);
                        }
                    }
                    break;
                case 2:
                    var sorrow_string = emotions[2].substring(7);
                    for(var i = 0; i < sorrow_string.length ; i ++){
                        if(sorrow_string.charAt(i) == '.'){
                            if((sorrow_string.charAt(i+1) == '0')  && (sorrow_string.substring(i+1).length > 1)){
                                return sorrow_string.substring(i+2);
                            }
                            return sorrow_string.substring(i+1);
                        }
                    }
                    break;
                case 3:
                    var fear_string = emotions[3].substring(5);
                    for(var i = 0; i < fear_string.length ; i ++){
                        if(fear_string.charAt(i) == '.'){
                            if((fear_string.charAt(i+1) == '0') && (fear_string.substring(i+1).length > 1)){
                                return fear_string.substring(i+2);
                            }
                            return fear_string.substring(i+1);
                        }
                    }
                    break;
            }
        }


        function initializeNPCs(){
            {% for npc in npc_list %}

                $("<div id='npc_parent_{{forloop.counter}}' class='col-sm-12 npc-container'> \
                    <div class='col-sm-7'> \
                        <div id='npc_child_{{forloop.counter}}' style='position:relative' class='" + getPanelClass("{{npc.getAction}}") +"'> \
                            <div class='panel-heading' style='text-align:center'> \
                                <h4 id='name_{{npc.sayHello}}' class='panel-title'> {{npc.sayHello}}</h4> \
                            </div> \
                            <div class='panel-body' id='npc_{{npc.sayHello}}'> \
                                <p id='emotion_{{npc.sayHello}}'>Emotions: {{npc.getEmotion | format_emotions}}</p> \
                                <p id='action_{{npc.sayHello}}'>Action: {{npc.getAction}}</p> \
                                <p id='weights_{{npc.sayHello}}'>Weights: {{npc.getWeights | format_weights}} </p> \
                                <p id='resources_{{npc.sayHello}}'>Resources: {{npc.getResources | format_weights }} </p> \
                                <p id='newresources_{{npc.sayHello}}'>New Resources: {{npc.getNewResources | format_weights}} </p> \
                            </div> \
                        </div> \
                    </div> \
                    <div class='col-sm-5'> \
                        <dl style='width:100%'> \
                            <dt id='joytext_{{npc.sayHello}}'> Joy {{npc.getEmotion | get_joy_percent }}%</dt> \
                            <dd><div id='joybar_{{npc.sayHello}}' class='graph_bar neutral_bar' style='width: {{npc.getEmotion | get_joy_percent }}%'> &nbsp</div></dd> \
                            <dt id='hopetext_{{npc.sayHello}}'> Hope  {{npc.getEmotion | get_hope_percent}}%</dt> \
                            <dd><div id='hopebar_{{npc.sayHello}}' class='graph_bar neutral_bar' style='width: {{npc.getEmotion | get_hope_percent}}%'> &nbsp</div></dd> \
                            <dt id='sorrowtext_{{npc.sayHello}}'>Sorrow {{npc.getEmotion | get_sorrow_percent}}%</dt> \
                            <dd><div id='sorrowbar_{{npc.sayHello}}' class='graph_bar neutral_bar' style='width: {{npc.getEmotion | get_sorrow_percent}}%'> &nbsp </div></dd> \
                            <dt id='feartext_{{npc.sayHello}}'> Fear {{npc.getEmotion | get_fear_percent}}%</dt> \
                            <dd><div id='fearbar_{{npc.sayHello}}' class='graph_bar neutral_bar' style='width: {{npc.getEmotion | get_fear_percent}}%'> &nbsp </div></dd> \
                        </dl> \
                    </div> \
                </div>").appendTo('#npc_div');

                //$("<li class='list-group-item' style='text-align:center; background-color:#ff00ff'> {{npc.sayHello}} </p>").appendTo('.list-group');
                $("<div  id='scoreboard_{{forloop.counter}}' class='" + getAlertClass("{{npc.getAction}}") + "' style='margin:0; text-align:center;'> {{npc.sayHello}}</div>").appendTo('#scoreboard');
            {% endfor %}
        }

        // function shiftLineAnimation(npcCount, height){
        //     return $.Deferred(function(){
        //         var self = this;

        //         setTimeout(function() {   // <-- example of some async operation
        //             $('<p> animating all panels </p>').appendTo('#scoreboard');

        //             for(var i = 2; i <= npcCount + 1; i++){
        //                 $('#npc_parent_' + i).animate({top: height}, {duration:3000, queue:false});
        //             }                    
        //             self.resolve();       // <-- call resolve method once async is done
        //         }, 3000);

        //         $('<p> done animating all panels </p>').appendTo('#scoreboard'); 
        //     });
        // }

        function updateNPCs(){
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("GET", "surveys/ajax", true);
            xmlhttp.onload=function(){
                    var npc_data = JSON.parse(xmlhttp.response);

                    //TODO at some point this should be changed to camelCase since it's javascript
                    var npc_count = npc_data["npc_count"];
                    var name_list = npc_data["names"];
                    var action_list = npc_data["actions"];
                    var emotion_list = npc_data["emotions"];
                    var weight_list = npc_data["weights"];
                    var resource_list = npc_data["resources"];
                    var newresource_list = npc_data["newresources"];
                    var gameStatus = npc_data["gameStatus"];
                    var passingNPCs = npc_data["passing_list"];
                    //$('<p>' + gameStatus + ' </p>').appendTo('#scoreboard')
                    //$('<p> ' + passingNPCs.length +' </p>').appendTo('#scoreboard')

                    if(gameStatus == 'penultimate'){ 
                        for(var i=0; i < passingNPCs.length; i ++){
                            var passingIndex = passingNPCs[i]
                            var movingUp = $('#npc_parent_'+ (passingIndex + 1));
                            var movingDown = $('#npc_parent_' + passingIndex);
                            var marginDif = parseInt(movingUp.css('marginTop')) + parseInt(movingDown.css('marginBottom'));
                            var upHeight = movingUp.outerHeight() + marginDif;
                            var downHeight = movingDown.outerHeight() + marginDif;
                            $.when(
                                movingUp.animate({top: -downHeight}, 750),
                                movingDown.animate({top: upHeight},750)).then( 
                                function(){ 
                                    movingUp.insertBefore(movingDown);
                                    movingUp.css('top', '0px');
                                    movingDown.css('top', '0px');
                            });


                            $('#npc_parent_'+ (passingIndex+1)).attr('id', 'ptemp');
                            $('#npc_parent_'+ passingIndex).attr('id', 'npc_parent_'+ (passingIndex + 1));                                
                            $('#ptemp').attr('id', 'npc_parent_' + passingIndex);

                            $('#npc_child_' + (passingIndex+1)).attr('id', 'ctemp');
                            $('#npc_child_'+ passingIndex).attr('id', 'npc_child_'+ (passingIndex + 1));                                
                            $('#ctemp').attr('id', 'npc_child_' + passingIndex);

                            $('#scoreboard_' + (passingIndex)).html(name_list[passingIndex-1]);
                            $('#scoreboard_' + (passingIndex + 1)).html(name_list[passingIndex]);
                        }
                    } else if (gameStatus == 'final'){
                        var panelHeight = $('#npc_parent_1').outerHeight();

                        $.when(
                            $('#npc_parent_1').animate({opacity: 0}, 750),
                            $('.npc-container').not('#test1').animate({top: -panelHeight}, 750)).then(

                        function () {
                            var npcPanel = document.getElementById('npc_parent_1');
                            var npcName = document.getElementById('scoreboard_1');
                            npcPanel.parentNode.removeChild(npcPanel);
                            npcName.parentNode.removeChild(npcName);
                            $('.npc-container').css('top', '0px');

                            for(var i = 2; i <=npc_count + 1; i++){
                                $('#npc_parent_' + i).attr('id', 'npc_parent_' + (i-1));
                                $('#npc_child_' + i).attr('id', 'npc_child_' + (i-1));
                                $('#scoreboard_' + i).attr('id', 'scoreboard_' + (i-1));
                            }
                        });

                        //$('<p> About to delete </p>').appendTo('#scoreboard');
                        // var npcPanel = document.getElementById('npc_parent_1');
                        // var npcName = document.getElementById('scoreboard_1');
                        // var panelHeight = $('#npc_parent_1').outerHeight();
                        // $('#npc_parent_1').fadeOut(500, function(){
                        //     npcPanel.parentNode.removeChild(npcPanel);
                        //     npcName.parentNode.removeChild(npcName);

                        //     for(var i = 2; i <= npc_count; i++){
                        //         $('#npc_parent_' + i).attr('top', '0px');
                        //     }

                        //     for(var i = 1; i <= npc_count; i ++){
                        //         $('#npc_parent_' + (i+1)).attr('id', 'npc_parent_' + i);
                        //         $('#npc_child_' + (i+1)).attr('id', 'npc_child_' + i);
                        //         $('#scoreboard_' + (i+1)).attr('id', 'scoreboard_' + i);
                        //     }
                        // });

                        // for(var i = 2; i <= npc_count; i++){
                        //     $('#npc_parent_' + i).animate({top: -panelHeight}, 400);
                        // }

                    }

                    for(var i = 0; i < npc_count; i++){
                        $('#name_' + name_list[i]).text(name_list[i]);
                        $('#emotion_'+ name_list[i]).text("Emotions: " + formatEmotion(emotion_list[i]));  
                        $('#action_'+ name_list[i]).text("Action: " + action_list[i]);
                        $('#weights_'+ name_list[i]).text("Weights: " + formatSpaces(weight_list[i]));
                        $('#resources_'+ name_list[i]).text("Resources: " + formatSpaces(resource_list[i]));
                        $('#newresources_'+ name_list[i]).text("New Resources: " + formatSpaces(newresource_list[i]));
                        $("#npc_child_"+ (i+1)).attr('class', getPanelClass(action_list[i]));
    
                        $('#scoreboard_' + (i+1)).attr('class', getAlertClass(action_list[i]));


                        //graph stuff
                        $('#joytext_' + name_list[i]).text('Joy ' + getEmotionPercent(emotion_list[i], 0) + '%');
                        $('#joybar_'+name_list[i]).width(getEmotionPercent(emotion_list[i], 0) + '%');
                        $('#hopetext_' + name_list[i]).text('Hope ' + getEmotionPercent(emotion_list[i], 1) + '%');
                        $('#hopebar_'+name_list[i]).width(getEmotionPercent(emotion_list[i], 1) +'%');
                        $('#sorrowtext_' + name_list[i]).text('Sorrow ' + getEmotionPercent(emotion_list[i], 2) + '%');
                        $('#sorrowbar_'+name_list[i]).width(getEmotionPercent(emotion_list[i], 2) + '%');
                        $('#feartext_' + name_list[i]).text('Fear ' + getEmotionPercent(emotion_list[i], 3) + '%');
                        $('#fearbar_'+name_list[i]).width(getEmotionPercent(emotion_list[i], 3) + '%');                        
                    }

            }
            xmlhttp.send();
        }

        $('document').ready(function(){
            $('#refresh_button').click(function(){
                updateNPCs();
            });

            initializeNPCs();
        });
    </script>
{% endblock js %}



